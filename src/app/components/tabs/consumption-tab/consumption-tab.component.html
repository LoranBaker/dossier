<div class="consumption-section">
    <div class="section-header">
      <h2>Ihre aktuellen Verbräuche und allgemeine Daten</h2>
      <div class="edit-controls">
        <button *ngIf="!isEditMode" class="edit-button" (click)="toggleEditMode()">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path>
          </svg>
          Bearbeiten
        </button>
        <div *ngIf="isEditMode" class="action-buttons">
          <button class="cancel-button" (click)="cancelChanges()">Abbrechen</button>
          <button class="save-button" (click)="saveChanges()">Speichern</button>
        </div>
      </div>
      <div id="consumption-saved-message" class="saved-message">Änderungen gespeichert</div>
    </div>
    
    <div class="consumption-data">
      <table class="data-table">
        <tr class="table-header">
          <th colspan="2">AKTUELLE DATEN UND VERBRAUCH</th>
        </tr>
        <tr>
          <td>Heizung in kWh</td>
          <td>
            <ng-container *ngIf="!isEditMode">{{consumptionData.heating | number}}</ng-container>
            <input *ngIf="isEditMode" type="number" [(ngModel)]="editableConsumptionData!.heating" 
                   (ngModelChange)="onValueChange()" class="edit-input">
          </td>
        </tr>
        <tr>
          <td>Warmwasser in kWh</td>
          <td>
            <ng-container *ngIf="!isEditMode">{{consumptionData.warmWater | number}}</ng-container>
            <input *ngIf="isEditMode" type="number" [(ngModel)]="editableConsumptionData!.warmWater" 
                   (ngModelChange)="onValueChange()" class="edit-input">
          </td>
        </tr>
        <tr>
          <td>Strom in kWh</td>
          <td>
            <ng-container *ngIf="!isEditMode">{{consumptionData.electricity | number}}</ng-container>
            <input *ngIf="isEditMode" type="number" [(ngModel)]="editableConsumptionData!.electricity" 
                   (ngModelChange)="onValueChange()" class="edit-input">
          </td>
        </tr>
        <tr>
          <td>Energie in kWh total</td>
          <td>
            <ng-container *ngIf="!isEditMode">{{consumptionData.totalEnergy | number}}</ng-container>
            <ng-container *ngIf="isEditMode">{{editableConsumptionData!.totalEnergy | number}}</ng-container>
          </td>
        </tr>
        <tr>
            <td>Mietpreis in € pro m²</td>
            <td>
              <ng-container *ngIf="!isEditMode">{{consumptionData.rentPrice || '-'}}</ng-container>
              <input *ngIf="isEditMode" type="number" [(ngModel)]="editableConsumptionData!.rentPrice" 
                     (ngModelChange)="onValueChange()" class="edit-input">
            </td>
          </tr>
          <tr>
            <td>Marktpreis in € pro m²</td>
            <td>
              <ng-container *ngIf="!isEditMode">{{consumptionData.marketPrice | number}}</ng-container>
              <input *ngIf="isEditMode" type="number" [(ngModel)]="editableConsumptionData!.marketPrice" 
                     (ngModelChange)="onValueChange()" class="edit-input">
            </td>
          </tr>
        <tr>
          <td>Energiekosten in €</td>
          <td>
            <ng-container *ngIf="!isEditMode">{{consumptionData.energyCosts | number}}</ng-container>
            <input *ngIf="isEditMode" type="number" [(ngModel)]="editableConsumptionData!.energyCosts" class="edit-input">
          </td>
        </tr>
        <tr>
        <td>CO₂-Emissionen in kg</td>
        <td>
          <ng-container *ngIf="!isEditMode">{{consumptionData.co2Emissions | number}}</ng-container>
          <ng-container *ngIf="isEditMode">{{editableConsumptionData!.co2Emissions | number}}</ng-container>
        </td>
      </tr>
        <tr>
          <td>Stranded Asset**</td>
          <td><span class="alert">ja</span></td>
        </tr>
      </table>
      
      <p class="footnote">Geschätzte Werte, da keine Angaben</p>
      <p class="footnote">*Stranded Asset heißt, dass Ihre Immobilie den Vorgaben der EU/CRREM nicht entspricht und ein Wertverlust droht.</p>
    
    <h3>ESG-Management (road to Paris)</h3>
      
    <div class="esg-data">
        <h4>Emission & Energie</h4>
        <div class="esg-table">
          <div class="esg-row">
            <div class="esg-cell">CO₂ - Intensität kg CO₂ - Aqu./m2</div>
            <div class="esg-cell">Emissionen gesamt kg CO₂ - Aqu.</div>
          </div>
          <div class="esg-row">
            <div class="esg-cell">
              <!-- Display calculated CO2 intensity -->
              {{isEditMode ? editableConsumptionData!.co2Intensity : consumptionData.co2Intensity}}
            </div>
            <div class="esg-cell">
              <!-- Display CO2 emissions from main data -->
              {{isEditMode ? editableConsumptionData!.co2Emissions : consumptionData.co2Emissions | number}}
            </div>
          </div>
          <div class="esg-row">
            <div class="esg-cell">Energie-Intensität kWh/m²</div>
            <div class="esg-cell">Energieverbrauch gesamt kWh</div>
          </div>
         <div class="esg-row">
        <div class="esg-cell">
          <!-- Display calculated energy intensity -->
          {{isEditMode ? editableConsumptionData!.energyIntensity : consumptionData.energyIntensity}}
        </div>
        <div class="esg-cell">
          <!-- Display heating + warm water only -->
          {{((isEditMode ? editableConsumptionData!.heating : consumptionData.heating) || 0) + ((isEditMode ? editableConsumptionData!.warmWater : consumptionData.warmWater) || 0) | number}}
        </div>
      </div>
        </div>
      </div>
    
      <div class="energy-rating">
        <h4>Energetische Einstufung</h4>
        <div class="rating-scale">
            <div class="scale-label" title="0-25 kWh/m²">A+</div>
            <div class="scale-label" title="25-50 kWh/m²">A</div>
            <div class="scale-label" title="50-75 kWh/m²">B</div>
            <div class="scale-label" title="75-100 kWh/m²">C</div>
            <div class="scale-label" title="100-125 kWh/m²">D</div>
            <div class="scale-label" title="125-150 kWh/m²">E</div>
            <div class="scale-label" title="150-175 kWh/m²">F</div>
            <div class="scale-label" title="175-200 kWh/m²">G</div>
            <div class="scale-label" title=">200 kWh/m²">H</div>
            <div class="scale-bar">
              <div class="marker" [style.left]="energyRatingPosition">
                <div class="arrow-up"></div>
                <span class="marker-tooltip">
                  {{isEditMode ? editableConsumptionData!.energyIntensity : consumptionData.energyIntensity}} kWh/m²
                </span>
              </div>
            </div>
          </div>
        
        <div class="energy-scale-values">
          <span>0</span>
          <span>25</span>
          <span>50</span>
          <span>75</span>
          <span>100</span>
          <span>125</span>
          <span>150</span>
          <span>175</span>
          <span>200</span>
          <span>&gt;250</span>
        </div>
      </div>
      <div class="co2-tax">
        <!-- Apple-style segmented control -->
        <div class="user-type-switch">
          <div class="toggle-container">
            <div class="segment-control">
              <input type="radio" name="user-type" id="eigennutzer" [(ngModel)]="isVermieter" [value]="false" (change)="onUserTypeChange()">
              <label for="eigennutzer">Eigennutzer</label>
              
              <input type="radio" name="user-type" id="vermieter" [(ngModel)]="isVermieter" [value]="true" (change)="onUserTypeChange()">
              <label for="vermieter">Vermieter</label>
              
              <span class="selection"></span>
            </div>
          </div>
        </div>
      
        <!-- Eigennutzer View -->
      <div *ngIf="!isVermieter">
    <p>CO₂ - Abgabe Euro (55 € / Tonne CO₂)</p>
    <p>{{calculateCO2TaxFromEmissions().perM2}} €/m² (Gesamt: {{calculateCO2TaxFromEmissions().total}} € p.a.)</p>
  </div>
      
        <!-- Vermieter View -->
        <div *ngIf="isVermieter">
          <p>CO₂ - Abgabe je m² Euro (55 € / Tonne CO₂)</p>
          <p>{{calculateVermieterCO2Tax()}} €/m² (Gesamt: {{calculateVermieterCO2TaxTotal()}} € p.a.)</p>
        </div>
      </div>
      </div>

    <h3>Stranding-Point-Analyse (CRREM-Methodik)</h3>
    <div class="stranding-data">
      <div class="stranding-box">
        <div class="stranding-title">
          Aktueller Stranding-Zeitpunkt 
          <ng-container *ngIf="!isEditMode">{{consumptionData.strandingPoint}}</ng-container>
          <input *ngIf="isEditMode" type="text" [(ngModel)]="editableConsumptionData!.strandingPoint" class="edit-input">
        </div>
      </div>
      <div class="stranding-box">
        <div class="stranding-title">
          Stranding Asset Risiko in: 
          <ng-container *ngIf="!isEditMode">{{consumptionData.strandingRisk}}</ng-container>
          <input *ngIf="isEditMode" type="number" [(ngModel)]="editableConsumptionData!.strandingRisk" class="edit-input small-input">
          Jahren (mind.)
          <span class="stranding-info-wrapper">
            <button type="button" class="stranding-info-btn" aria-label="Info zum Stranding Asset Risiko" aria-describedby="stranding-tooltip">
              <svg width="14" height="14" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                <circle cx="10" cy="10" r="9" stroke="#ffffff" stroke-width="1.5" fill="none" />
                <text x="10" y="14" text-anchor="middle" font-size="11" font-family="system-ui, -apple-system, 'Inter', sans-serif" font-weight="600" fill="#ffffff">i</text>
              </svg>
            </button>
            <span id="stranding-tooltip" class="stranding-tooltip" role="tooltip">
             Falls bei Ihnen ein negativer Jahreswert steht,
              dann bedeutet es, dass Ihre Immobilie seit den aufgeführten
              Jahren nicht den CRREM-Vorgaben entspricht!
              <span class="tooltip-arrow"></span>
            </span>
          </span>
        </div>
      </div>
    </div>
  </div>

  <!-- Enhanced Apple-style tooltip -->
<style>
  .stranding-info-wrapper { 
    position: relative; 
    display: inline-flex; 
    align-items: center; 
    margin-left: 8px; 
  }
  
  .stranding-info-btn {
    -webkit-appearance: none;
    appearance: none;
    cursor: pointer;
    border: none;
    outline: none;
    width: 22px;
    height: 22px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    background: linear-gradient(135deg, #ff4757 0%, #ff3742 100%);
    border: 1px solid rgba(255, 71, 87, 0.3);
    color: #ffffff;
    font-weight: 600;
    font-size: 12px;
    line-height: 1;
    padding: 0;
    transition: all 0.2s cubic-bezier(0.25, 0.8, 0.5, 1);
    box-shadow: 
      0 2px 6px rgba(255, 71, 87, 0.25),
      0 1px 2px rgba(0, 0, 0, 0.1),
      0 0 0 1px rgba(255, 255, 255, 0.2) inset;
  }
  
  .stranding-info-btn:hover {
    background: linear-gradient(135deg, #ff3742 0%, #ff2a37 100%);
    border-color: rgba(255, 71, 87, 0.4);
    transform: translateY(-2px);
    box-shadow: 
      0 6px 12px rgba(255, 71, 87, 0.35),
      0 2px 4px rgba(0, 0, 0, 0.15),
      0 0 0 1px rgba(255, 255, 255, 0.3) inset;
  }
  
  .stranding-info-btn:active {
    transform: translateY(0);
    box-shadow: 
      0 1px 2px rgba(0, 0, 0, 0.1),
      0 0 0 1px rgba(255, 255, 255, 0.8) inset;
  }
  
  .stranding-info-btn:focus-visible {
    box-shadow: 
      0 0 0 2px #fff,
      0 0 0 4px #0071e3,
      0 1px 3px rgba(0, 0, 0, 0.1);
  }

  .stranding-tooltip {
    position: absolute;
    bottom: calc(100% + 12px);
    left: 50%;
    transform: translateX(-50%) translateY(8px);
    background: rgba(28, 28, 30, 0.95);
    color: #ffffff;
    padding: 12px 16px;
    border-radius: 12px;
    width: 250px !important;
    min-width: 250px !important;
    max-width: none !important;
    font-size: 13px;
    line-height: 1.4;
    font-weight: 400;
    letter-spacing: 0.1px;
    text-align: left;
    box-shadow: 
      0 8px 24px rgba(0, 0, 0, 0.3),
      0 2px 8px rgba(0, 0, 0, 0.2),
      0 0 0 0.5px rgba(255, 255, 255, 0.1) inset;
    backdrop-filter: blur(20px) saturate(180%);
    -webkit-backdrop-filter: blur(20px) saturate(180%);
    opacity: 0;
    pointer-events: none;
    transition: all 0.25s cubic-bezier(0.25, 0.8, 0.5, 1);
    z-index: 1000;
    white-space: normal;
    word-wrap: break-word;
  }
  
  .stranding-info-wrapper:hover .stranding-tooltip,
  .stranding-info-btn:focus + .stranding-tooltip,
  .stranding-info-wrapper:focus-within .stranding-tooltip {
    opacity: 1;
    transform: translateX(-50%) translateY(0);
    pointer-events: auto;
  }
  
  .stranding-tooltip .tooltip-arrow {
    position: absolute;
    top: 100%;
    left: 50%;
    transform: translateX(-50%);
    width: 0;
    height: 0;
    border-left: 8px solid transparent;
    border-right: 8px solid transparent;
    border-top: 8px solid rgba(28, 28, 30, 0.95);
    filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.1));
  }
  
  /* Dark mode support */
  @media (prefers-color-scheme: dark) {
    .stranding-info-btn {
      background: linear-gradient(135deg, #ff4757 0%, #ff3742 100%);
      border-color: rgba(255, 71, 87, 0.3);
      color: #ffffff;
    }
    .stranding-info-btn:hover {
      background: linear-gradient(135deg, #ff3742 0%, #ff2a37 100%);
      border-color: rgba(255, 71, 87, 0.4);
    }
  }
  
  /* High contrast mode */
  @media (prefers-contrast: high) {
    .stranding-info-btn {
      border: 2px solid #0071e3;
      background: #ffffff;
    }
    .stranding-tooltip {
      background: #000000;
      border: 1px solid #ffffff;
    }
  }
  
  /* Reduced motion */
  @media (prefers-reduced-motion: reduce) {
    .stranding-info-btn,
    .stranding-tooltip {
      transition: none;
    }
  }
  
  /* Print styles */
  @media print {
    .stranding-info-btn {
      display: none !important;
    }
    .stranding-tooltip {
      position: static;
      opacity: 1;
      transform: none;
      background: #f5f5f5;
      color: #000000;
      box-shadow: none;
      border: 1px solid #cccccc;
      margin-left: 8px;
      display: inline-block;
    }
  }
</style>